#+TITLE: doom-literate-config
#+DESCRIPTION: Doom Emacs literate config.
#+LANGUAGE: en
#+TAGS: package(p) advice(a) disabled(d) hook(h) bind(b) setq(s) noexport(x) popup(u) hack(H)
#+TODO: TODO
#+OPTIONS: tags:t tasks:t todo:t inline:t num:nil toc:nil html-style:nil
#+STARTUP: indent hidestars
#+PROPERTY: header-args:emacs-lisp :tangle ~/.doom.d/config.el :tangle-mode (identity #o400) :results silent :exports code :lexical yes :mkdirp no
#+HTML_HEAD: <link rel="preload" href="Zenburn.woff2" as="font" type="font/woff2" />
#+HTML_HEAD_EXTRA: <link rel="stylesheet" type="text/css" href="config.css" />
#+EXPORT_FILE_NAME: index.html
#+LINK_HOME: https://gruner.lu/kasz/

* =*DOOM*=
** Add file headers
*** for =config.el=
#+begin_src emacs-lisp
;;; ~/.doom.d/config.el -*- lexical-binding: t; -*-
#+end_src
*** and =packages.el=
#+begin_src emacs-lisp :tangle ~/.doom.d/packages.el
;;; ~/.doom.d/packages.el -*- no-byte-compile: t; lexical-binding: t; -*-
#+end_src
*** load or create =custom.el=                                          :setq:
#+begin_src emacs-lisp
(setq! custom-file (expand-file-name "custom.el" doom-private-dir))
(if (file-exists-p custom-file)
    (load custom-file)
  (with-temp-file custom-file
    (insert ";;; ~/.doom.d/custom.el -*- no-byte-compile: t; lexical-binding: t; -*-\n")))
#+end_src
*** ask about unsaved customizations
#+begin_src emacs-lisp
(add-hook! 'kill-emacs-query-functions #'custom-save-all)
#+end_src
** Modules configuration (init.el)
#+begin_src emacs-lisp :tangle ~/.doom.d/init.el
;;; ~/.doom.d/init.el -*- lexical-binding: t; -*-
(doom! :completion (company -tng) (vertico +icons)
       :ui         doom doom-dashboard doom-quit
                   hl-todo modeline nav-flash ophints treemacs
                   (popup +all +defaults) vc-gutter vi-tilde-fringe workspaces
       :editor     (evil +everywhere) file-templates fold format snippets word-wrap
       :emacs      (dired +icons) (ibuffer +icons) undo vc
       :term       vterm
       :checkers   syntax
       :tools      ansible debugger (docker +lsp) (eval +overlay)
                   (lookup +docsets) (lsp +peek) magit make prodigy upload
       :os         tty
       :lang       (cc +lsp) data emacs-lisp (go +lsp) (java +lsp)
                   (javascript +lsp) (json +lsp) lua markdown org (python +lsp)
                   rest (rust +lsp) (sh +fish +lsp) (web +lsp) (yaml +lsp)
       :config     literate (default +bindings))
#+end_src
** *HACKS*
*** fix defvaralias eldoc-documentation-function                   :setq:hack:
conflict between eldoc version from emacs28 (installed by doom) and emacs version 27.1
take note that doom-emacs doesn't yet support emacs version 28
#+begin_src emacs-lisp
(defvar eldoc-documentation-strategy 'eldoc-documentation-default "Now defvaralias won't fail.")
#+end_src
** My Library of useful stuff
*** Locally remap q to exit buffer
Some modes don't require macros (like most RO buffers).
#+begin_src emacs-lisp
(defun uki/local-remap-q-kills-buffer ()
  (define-key evil-normal-state-local-map (kbd "q") #'kill-current-buffer))
#+end_src
* Minor-modes
** =Builtin= and one-liners
*** Personal info                                                       :setq:
#+begin_src emacs-lisp
(setq! user-full-name    "Łukasz Gruner"
       user-mail-address "lukasz@gruner.lu")
#+end_src
*** Set theme & font                                            :package:setq:
~doom-zenburn-theme~ is installed by =:ui doom=
#+begin_src emacs-lisp
(setq! doom-theme               'doom-zenburn
       doom-variable-pitch-font "DejaVu Sans:size=12"
       doom-font                "Terminus:size=16"
       doom-big-font            "Terminus:size=22")
#+end_src
*** Start maximized
#+begin_src emacs-lisp
(add-to-list 'default-frame-alist '(fullscreen . maximized))
(add-to-list 'initial-frame-alist '(fullscreen . maximized))
#+end_src
*** Define const vars                                                   :setq:
#+begin_src emacs-lisp
(defconst uki/dotfiles-dir "~/src/dot/" "Dotfiles repository root.")

(defconst uki/ellipsis "…" "Ellipsis.")
#+end_src
*** Authinfo
**** file location                                                     :setq:
#+begin_src emacs-lisp
(after! auth-source
  (setq! auth-sources (list (expand-file-name "hidden/authinfo.gpg" uki/dotfiles-dir))))
#+end_src
*** If '.elc' file is outdated load an uncompiled '.el' file instead    :setq:
#+begin_src emacs-lisp
(setq! load-prefer-newer t)
#+end_src
*** Make scripts executable on save                                     :hook:
#+begin_src emacs-lisp
(add-hook! 'after-save-hook
          #'executable-make-buffer-file-executable-if-script-p)
#+end_src
*** *<mouse-1>* should follow links                                     :setq:
#+begin_src emacs-lisp
(setq! mouse-1-click-follows-link t)
#+end_src
*** Enable ~+global-word-wrap-mode~
#+begin_src emacs-lisp
(after! (:and simple adaptive-wrap)
  (+global-word-wrap-mode +1))
#+end_src
*** Only highlight trailing whitespace when coding                 :hook:setq:
#+begin_src emacs-lisp
(add-hook! '(prog-mode-hook org-mode-hook)
  (defun uki/set-whitespace-style-to-trailing-space-h ()
    "Set local value for `whitespace-style'."
    (setq-local whitespace-style '(face trailing))))
#+end_src
** Persp
*** Kill buffers removed from workspace and empty workspaces            :setq:
#+begin_src emacs-lisp
(after! persp-mode
  (setq! persp-autokill-buffer-on-remove 'kill
         persp-autokill-persp-when-removed-last-buffer 'kill))
#+end_src
** Hl-Todo
*** Setup colors/faces                                                  :setq:
#+begin_src emacs-lisp
(after! hl-todo
  (setq! hl-todo-keyword-faces `(("TODO" font-lock-warning-face bold)
                                 ("FIXME" error bold)
                                 ("HACK" font-lock-keyword-face bold)
                                 ("XXX" font-lock-doc-face bold))))
#+end_src
*** Highlight background                                                :setq:
#+begin_src emacs-lisp
(after! hl-todo
  (setq! hl-todo-color-background t))
#+end_src
** Electric-Pair
*** Be conservative                                                     :setq:
#+begin_src emacs-lisp
(after! elec-pair
  (setq! electric-pair-inhibit-predicate #'electric-pair-conservative-inhibit))
#+end_src
*** Run in prog-mode derivatives                                        :hook:
#+begin_src emacs-lisp
(declare-function electric-pair-local-mode "elec-pair" (&optional arg))
(after! elec-pair
  (add-hook! 'prog-mode-hook #'electric-pair-local-mode))
#+end_src
*** Define pairs                                                        :hook:
#+begin_src emacs-lisp
(declare-function electric-pair-local-mode "elec-pair" (&optional arg))
(after! elec-pair
  (setq! electric-pair-text-pairs `((?\" . ?\"))
         electric-pair-pairs `((?\" . ?\"))))
#+end_src
** Doom-Modeline
*** Use icons in graphic mode                                           :setq:
#+begin_src emacs-lisp
(after! doom-modeline
  (let ((graphic-p (display-graphic-p)))
    (setq! doom-modeline-height 22
           doom-modeline-unicode-fallback t
           doom-modeline-icon graphic-p
           doom-modeline-major-mode-icon graphic-p
           doom-modeline-major-mode-color-icon graphic-p
           doom-modeline-buffer-state-icon graphic-p
           doom-modeline-buffer-modification-icon graphic-p
           doom-modeline-modal-icon graphic-p)))
#+end_src
*** Don't upscale icon font                                             :setq:
#+begin_src emacs-lisp
(after! all-the-icons
  (setq! all-the-icons-scale-factor 1.0))
#+end_src
*** Truncate ~buffer-file-name~ up to project                           :setq:
#+begin_src emacs-lisp
(after! doom-modeline
  (setq! doom-modeline-buffer-file-name-style 'truncate-upto-project))
#+end_src
** Evil
*** <C-w M-(direction)> Swap buffers by direction                       :bind:
#+begin_src emacs-lisp
(defmacro uki/window-swap-action (cmd)
  "Return defun which invokes `CMD' to switch window and than swaps buffer with previous window."
  (let ((func-sym (intern (format "uki/swap-buffers-using--%s" cmd))))
    (if (functionp func-sym)
        `(quote ,func-sym)
      `(defun ,func-sym (&optional count)
         ,(format "Invoke `%s' and swap buffer with window it selects."
                  (upcase (symbol-name cmd)))
         (interactive "p")
         (let ((start-buffer (current-buffer))
               (start-point  (point))
               (start-window (selected-window)))
           (funcall #',cmd (max 1 (or count 0)))
           (set-window-buffer start-window (current-buffer))
           (set-window-buffer (selected-window) start-buffer)
           (goto-char start-point))))))

(map! :after evil :map evil-window-map
      "M-k"       (uki/window-swap-action evil-window-up)
      "<M-up>"    (uki/window-swap-action evil-window-up)
      "M-j"       (uki/window-swap-action evil-window-down)
      "<M-down>"  (uki/window-swap-action evil-window-down)
      "M-l"       (uki/window-swap-action evil-window-right)
      "<M-right>" (uki/window-swap-action evil-window-right)
      "M-h"       (uki/window-swap-action evil-window-left)
      "<M-left>"  (uki/window-swap-action evil-window-left))
#+end_src
*** Always use windows <C-w> bindings                                   :setq:
#+begin_src emacs-lisp
(after! evil
  (setq! evil-want-C-w-in-emacs-state t))
#+end_src
*** Also use arrows for switching windows                               :bind:
#+begin_src emacs-lisp
(map! :after evil :map evil-window-map
      "<left>"  #'evil-window-left
      "<right>" #'evil-window-right
      "<up>"    #'evil-window-up
      "<down>"  #'evil-window-down)
#+end_src
* Major-modes
** Messages-Buffer
*** <q> exits buffer/window
#+begin_src emacs-lisp
(add-hook! 'messages-buffer-mode-hook #'uki/local-remap-q-kills-buffer)
#+end_src
** Prog
*** <C-x =>/<SPC c => Align your code in a pretty way                   :bind:
#+begin_src emacs-lisp
(map! :map prog-mode-map
      "C-x =" #'align-regexp
      (:leader :prefix ("c" "+code")
        :desc "Align regexp" "=" #'align-regexp))
#+end_src
*** Highlight trailing whitespace                                  :hook:setq:
#+begin_src emacs-lisp
(add-hook! 'prog-mode-hook (defun uki/set-trailing-whitespace-h ()
                             "Set `show-trailing-whitespace'."
                             (setq! show-trailing-whitespace t)))
#+end_src
** Dired
*** Reuse current dired buffer when changing directories                :bind:
#+begin_src emacs-lisp
(defun uki/up-directory-alternative ()
  "Use single instance of dired buffer when going up a directory."
  (interactive)
  (set-buffer-modified-p nil) ;; don't need to save dired buffers
  (find-alternate-file ".."))

(defun uki/find-alt-file-for-directories ()
  "Use single instance of dired buffer when opening files."
  (interactive)
  (let ((file (dired-get-file-for-visit)))
    (if (file-directory-p file)
        (progn
          (set-buffer-modified-p nil) ;; don't need to save dired buffers
          (find-alternate-file file))
      (find-file file))))

(map! :after dired :map dired-mode-map
      [remap dired-find-file]    #'uki/find-alt-file-for-directories
      [remap dired-up-directory] #'uki/up-directory-alternative)
#+end_src
*** Permanent ~dired-hide-details-mode~                                 :bind:
#+begin_src emacs-lisp
(defun uki/init-permanent-dired-hide-details-mode (sym exp)
  "Restore saved mode state or set a new value."
  (custom-initialize-reset sym exp)
  (when (eq major-mode 'dired-mode) (dired-hide-details-mode exp))
  (if exp
      (add-hook! 'dired-mode-hook #'dired-hide-details-mode)
    (remove-hook! 'dired-mode-hook #'dired-hide-details-mode)))

(defcustom uki/permanent-dired-hide-details-mode-state nil
  "State of `dired-hide-details-mode' saved between restarts."
  :group 'user
  :type 'bool
  :initialize #'uki/init-permanent-dired-hide-details-mode)

(defun uki/toggle-permanent-dired-hide-details-mode ()
  "Toggles `dired-hide-details-mode' for current and future dired buffers."
  (interactive)
  (uki/init-permanent-dired-hide-details-mode
   'uki/permanent-dired-hide-details-mode-state
   (not uki/permanent-dired-hide-details-mode-state)))

(map! :after dired :map dired-mode-map
      (:localleader :desc "Hide-Details" "d" #'uki/toggle-permanent-dired-hide-details-mode)
      ([remap dired-hide-details-mode] #'uki/toggle-permanent-dired-hide-details-mode))
#+end_src
*** Run dired instead of listing directory
Why so complicated? [[https://nullprogram.com/blog/2019/12/10/#cl-first]]
#+begin_src emacs-lisp
(after! dired
  (defalias 'list-directory 'dired)
  (put 'list-directory 'byte-optimizer 'byte-compile-inline-expand))
#+end_src
** Org
*** Startup options                                                     :setq:
#+begin_src emacs-lisp
(after! org
  (setq! org-tags-column -80
         org-startup-indented t
         org-startup-folded t
         org-startup-truncated t
         org-startup-align-all-tables t))
#+end_src
*** My ~org-directory~                                                  :setq:
#+begin_src emacs-lisp
(setq! org-directory "~/org/")
#+end_src
*** Bind ~org-babel-tangle~ under :localleader                          :bind:
#+begin_src emacs-lisp
(map! :after org :map org-mode-map
      :localleader :desc "Tangle current file" "B" #'org-babel-tangle)
#+end_src
*** Follow link under point with <RET>                                  :setq:
#+begin_src emacs-lisp
(after! org
  (setq! org-return-follows-link t))
#+end_src
*** Publishing                                                          :setq:
#+begin_src emacs-lisp
(after! ox-publish
  (let* ((root-dir "/davs:ukaszg@fastmail.fm@myfiles.fastmail.com:/www/")
         (conf-dir (concat root-dir "config/"))
         (doompath (expand-file-name "hidden/doom.d/" uki/dotfiles-dir)))
    (setq! org-publish-project-alist
           `(("gruner.lu/kasz/config" :components ("config-static-resources" "config/index.html"))
             ("config-static-resources"
              :base-directory ,doompath
              :publishing-directory ,conf-dir
              :publishing-function org-publish-attachment
              :include ("favicon.ico" "config.css" "Droid_Sans_Mono.woff2")
              :exclude ".*")
             ("config/index.html"
              :base-directory ,doompath
              :include ("config.org")
              :exclude ".*"
              :publishing-directory ,conf-dir
              :html-postamble nil
              :publishing-function org-html-publish-to-html
              :keywords "config.org, doom-literate-config, init.el"
              :html-doctype "html5"
              :html-html5-fancy t)))))
#+end_src
*** [Flycheck] Disable textlint checker                            :hook:setq:
#+begin_src emacs-lisp
(after! org
  (add-hook! 'org-mode-hook
    (cl-pushnew 'textlint flycheck-disabled-checkers)))
#+end_src
*** Have export dialog open in place and without modeline              :popup:
#+begin_src emacs-lisp
(after! org
  (require 'ox nil t)
  (set-popup-rule! "^ ?\\*Org Export Dispatcher"
    :actions '(display-buffer-same-window)
    :modeline nil))
#+end_src
*** Have =org-src= buffers be managed by orgmode                  :setq:popup:
#+begin_src emacs-lisp
(after! org
  (setq! org-src-window-setup 'current-window)
  (set-popup-rule! "^\\*Org Src"
    :actions '(display-buffer-same-window)
    :quit nil :select t :autosave t :modeline nil :ttl nil))
#+end_src
*** Enable and fix =org-eldoc=                                   :advice:hook:
DOOM doesn't use stock Eldoc which causes =org-eldoc= to assume
Emacs is version 28 (with more recent emacs-lisp-mode).
So I bind old documentation function to new handles.
#+begin_src emacs-lisp
(unless (<= 28 emacs-major-version)
  (after! org
    (require 'org-eldoc nil t)
    (add-hook! '(org-mode-hook)
               :append
               (defun uki/enable-org-eldoc-h (&rest _)
                 "Setup `eldoc-documentation-function' and enable `org-eldoc-mode'."
                 (interactive)
                 (setq-local eldoc-documentation-strategy 'eldoc-documentation-default)
                 (add-function :before-until (local 'eldoc-documentation-function)
                               #'org-eldoc-documentation-function)
                 (puthash "org"
                          #'org-eldoc-documentation-function
                          org-eldoc-local-functions-cache)
                 (eldoc-mode +1)))))
#+end_src
*** Block templates
#+begin_src emacs-lisp
(require 'org-tempo)
(add-to-list 'org-structure-template-alist '("el" . "src emacs-lisp"))
#+end_src
** Info
*** Automatically view '.info' files instead of editing them            :setq:
#+begin_src emacs-lisp
(add-to-list 'auto-mode-alist
             (cons "\\.[iI][nN][fF][oO]\\'"
                   (defun uki/reopen-file-in-info-mode-h ()
                     "Run this in an info viewer."
                     (interactive)
                     (let ((file-name (buffer-file-name)))
                       (kill-buffer)
                       (info file-name)))))
#+end_src
*** Display =*info*= buffers in same window                            :popup:
and disable the modeline.
#+begin_src emacs-lisp
(set-popup-rule! "^\\*info\\*$"
  :actions '(display-buffer-same-window)
  :modeline nil)
#+end_src
*** Left mouse button should follow links                               :bind:
#+begin_src emacs-lisp
(map! :after info :map Info-mode-map
      "<mouse-1>" #'Info-mouse-follow-nearest-node)
#+end_src
** Emacs-Lisp
*** Eldoc will show 1st line of function documentation                :advice:
#+begin_src emacs-lisp
(declare-function helpful--docstring "helpful" (sym callable-p))

(defadvice! uki/eldoc-elisp-add-fundoc-a (orig-fn sym &optional index prefix)
  "Add a 1st line of docstring to ElDoc's function information."
  :around #'elisp-get-fnsym-args-string
  (require 'helpful)
  (let ((orig (funcall orig-fn sym index prefix))
        (doc  (condition-case nil
                  (replace-regexp-in-string "[\t \n\r]+"
                                            " "
                                            (substitute-command-keys
                                             (helpful--docstring sym t))
                                            t
                                            t)
                (error ""))))
    (if (s-blank? doc)
        orig
      (s-truncate
       (- (frame-width) (length orig) 1)
       (concat orig " " (propertize doc 'face 'font-lock-doc-face))
       (concat "[" uki/ellipsis "]")))))
#+end_src
*** [Flycheck] Disable elisp-checkdoc                              :hook:setq:
#+begin_src emacs-lisp
(after! flycheck
  (add-hook! 'emacs-lisp-mode-hook
    (cl-pushnew 'emacs-lisp-checkdoc flycheck-disabled-checkers)))
#+end_src
** Java
*** Set ~compile-command~ to maven                                 :hook:setq:
#+begin_src emacs-lisp
(add-hook! 'java-mode-hook
  (defun uki/set-mvn-cc ()
    (setq-local compile-command "mvn clean install -DskipTests")))
#+end_src
*** Use long lines                                                 :hook:setq:
#+begin_src emacs-lisp
(setq-hook! 'java-mode-hook
  fill-column 160)
#+end_src
*** Load formatter configuration if present
#+begin_src emacs-lisp
(after! lsp-java
  (let ((formatter (expand-file-name "~/.formatter.xml")))
    (if (file-exists-p formatter)
      (setq! lsp-java-format-enabled t
             lsp-java-format-settings-url formatter)
      (message "No formatter file present: %s" formatter))))
#+end_src
*** Always use code blocks
#+begin_src emacs-lisp
(after! lsp-java
  (setq! lsp-java-code-generation-use-blocks t))
#+end_src
*** LSP vm args
#+begin_src emacs-lisp
(after! lsp-java
  (setq! lsp-java-vmargs
         '("-XX:UseParallelGC" "-XX:GCTimeRatio=4" "-XX:AdaptiveSizePolicyWeight=90"
           "-Dsun.zip.disableMemoryMapping=true" "-Xmx2G" "-Xms512m" "-XX:+UseStringDeduplication")))
#+end_src
** Compilation
*** Have <q> exit window                                           :hook:bind:
#+begin_src emacs-lisp
(add-hook! 'compilation-mode-hook #'uki/local-remap-q-kills-buffer)
#+end_src
** Special
*** Have <q> exit window                                           :hook:bind:
#+begin_src emacs-lisp
(add-hook! 'special-mode-hook #'uki/local-remap-q-kills-buffer)
#+end_src
** Comint
*** Have <q> exit window                                           :hook:bind:
#+begin_src emacs-lisp
(add-hook! 'comint-mode-hook #'uki/local-remap-q-kills-buffer)
#+end_src

* Auto tangle & compile
My =~/.doom.d/config.org= is a softlink, so depending on if I open a symlink or
concrete file, ~+literate-enable-recompile-h~ might not recognize it as literate config.

As a workaround I disable literate autotangle.
#+begin_src emacs-lisp
(after! org
  (remove-hook 'org-mode-hook #'+literate-enable-recompile-h))
#+end_src

And then add following at the end of =config.org= (this will also compile tangled files).
: # Local Variables:
: # eval: (add-hook! 'after-save-hook (progn (org-babel-tangle) (byte-recompile-directory doom-private-dir 0 t)) nil t)
: # End:
